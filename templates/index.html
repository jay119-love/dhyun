<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Try On!</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
<style>
body { 
    background: #ffffff; 
    color: #333; 
    text-align: center; 
    font-family: "Noto Sans KR", sans-serif; 
    margin: 0;
    padding: 0;
    overflow: hidden;
    height: 100vh;
    width: 100vw; 
    cursor: pointer; 
}
.title-container {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 5;
}
.handwritten-text {
    font-family: 'Great Vibes', cursive;
    font-size: 90px;
    color: rgba(20, 20, 20, 0.9);
    white-space: nowrap;
    overflow: hidden;
    border-right: none;
    animation: drawText 4s ease forwards;
    stroke-width: 1px;
    text-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
@keyframes drawText {
    from { width: 0; }
    to { width: 100%; }
}
.handwritten-text {
    display: inline-block;
    white-space: nowrap;
    animation: handwriting 5s ease-out forwards;
    border: none;
}
@keyframes handwriting {
    0% { opacity: 0; clip-path: inset(0 100% 0 0); }
    10% { opacity: 1; }
    100% { clip-path: inset(0 0 0 0); }
}
.touch-guide {
    position: absolute;
    top: 8%;
    left: 50%;
    transform: translateX(-50%);
    font-family: "Pretendard", sans-serif;
    font-size: 32px;
    font-weight: 600;
    color: #ffffff;
    text-shadow:
        0 0 3px rgba(0,0,0,0.9),
        0 0 6px rgba(0,0,0,0.7),
        0 0 12px rgba(255,255,255,0.9), 
        0 0 20px rgba(255,255,255,0.7);
    opacity: 0;
    animation: fadeInPulse 1.5s ease-out 5s forwards, pulse 2.2s ease-in-out 6.5s infinite;
    z-index: 10;
}
@keyframes fadeInPulse {
    0% { opacity: 0; transform: translateX(-50%) scale(1); }
    40% { opacity: 1; }
    100% { opacity: 1; transform: translateX(-50%) scale(1); }
}
@keyframes pulse {
    0% { transform: translateX(-50%) scale(1); }
    50% { transform: translateX(-50%) scale(1.12); }
    100% { transform: translateX(-50%) scale(1); }
}
.clothing-container {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%; 
    width: 100%;
    pointer-events: none;
    overflow: hidden;
}
.clothing-row {
    display: flex;
    gap: 2vw;
    position: absolute;
    left: 0;
    width: max-content;
}
.clothing-item {
    height: 25vh; 
    min-width: 25vh;
    display: block; 
    background: #ffffff;
    overflow: hidden;
}
.clothing-item img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
    border: none;
    transform: scale(0.8);
    transition: transform 0s;
}
.row-1 { animation: slideRight 30s linear infinite; top: 0%; }
.row-2 { animation: slideLeft 35s linear infinite; top: 25%; }
.row-3 { animation: slideRight 32s linear infinite; top: 50%; }
.row-4 { animation: slideLeft 38s linear infinite; top: 75%; }
@keyframes slideRight {
    0% { transform: translateX(-50%); }
    100% { transform: translateX(0); }
}
@keyframes slideLeft {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
}
</style>
</head>

<body>

<div class="clothing-container">
    <div class="clothing-row row-1">
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (1).jpg') }}"></div>
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (2).jpg') }}"></div>
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (3).jpg') }}"></div>
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (4).jpg') }}"></div>
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (5).jpg') }}"></div>
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (1).jpg') }}"></div>
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (2).jpg') }}"></div>
    </div>
    <div class="clothing-row row-2">
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (6).jpg') }}"></div>
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (7).jpg') }}"></div>
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (8).jpg') }}"></div>
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (9).jpg') }}"></div>
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (10).jpg') }}"></div>
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (6).jpg') }}"></div>
    </div>
    <div class="clothing-row row-3">
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (11).jpg') }}"></div>
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (12).jpg') }}"></div>
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (13).jpg') }}"></div>
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (14).jpg') }}"></div>
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (15).jpg') }}"></div>
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (11).jpg') }}"></div>
    </div>
    <div class="clothing-row row-4">
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (16).jpg') }}"></div>
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (17).jpg') }}"></div>
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (18).jpg') }}"></div>
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (19).jpg') }}"></div>
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (20).jpg') }}"></div>
        <div class="clothing-item"><img src="{{ url_for('static', filename='images/Clothes (16).jpg') }}"></div>
    </div>
</div>

<div class="title-container">
    <h1 class="handwritten-text">Style On You</h1>
</div>

<div class="touch-guide">화면을 터치해주세요</div>

<script>
// [뷔페] TTS 재생 함수 (미리 만든 MP3 재생)
const audioMap = {
    // ◀◀◀ 뷔페 맵. 'nova'로 픽스 (맘에 안들면 'shimmer', 'alloy' 등으로 바꾸세요)
    "안녕하세요~ 시작이라고 말하시거나 화면터치해주세요!": "/static/audio/nova/welcome.mp3",
    "촬영이라고 말해주세요": "/static/audio/nova/capture_prompt.mp3",
    "3, 2, 1, 치즈~": "/static/audio/nova/capture_countdown.mp3",
    "와 잘 나오셨어요! 다시한번 찍을까요? 아님 넘어갈까요?": "/static/audio/nova/review_prompt.mp3",
    "어떤 조합을 입어볼까요?": "/static/audio/nova/select_prompt.mp3",
    "상의 또는 하의를 선택해주세요.": "/static/audio/nova/select_error.mp3",
    "당신의 스타일을 완성중이에요!": "/static/audio/nova/loading_1.mp3",
    "잠시만 기다려주세요~": "/static/audio/nova/loading_2.mp3",
    "와~ 멋진데요?": "/static/audio/nova/result_prompt.mp3"
};

async function playTTS(text) {
    if (window.currentAudio) {
        window.currentAudio.pause();
    }
    const audioUrl = audioMap[text];
    if (audioUrl) {
        // (캐시 방지를 위해 타임스탬프 추가)
        const audio = new Audio(`${audioUrl}?v=${new Date().getTime()}`);
        window.currentAudio = audio;
        audio.play();
    } else {
        console.warn(`재생할 MP3 파일이 없습니다: ${text}`);
    }
}

// [수정됨] STT와 클릭 리스너 충돌 해결
window.addEventListener("DOMContentLoaded", () => {
    
    // 1. TTS는 즉시 재생 (welcome.html 클릭 덕분에 권한 있음)
    playTTS("안녕하세요~ 시작이라고 말하시거나 화면터치해주세요!");
    
    let recognition = null;
    let isListening = false;
    
    // 2. STT(음성) 기능 준비
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'ko-KR';
        recognition.continuous = true;
        recognition.interimResults = false;

        recognition.onresult = async function(event) {
            const transcript = event.results[event.results.length - 1][0].transcript.trim();
            console.log("음성인식 결과:", transcript);
            if (transcript.includes("시작") || transcript.includes("넥스트") || transcript.includes("다음")) {
                if (recognition && isListening) { // ◀◀ 페이지 넘어가기 전 STT 끄기
                    recognition.abort();
                    isListening = false;
                }
                window.location.href = "/capture";
            }
        };

        recognition.onerror = function(event) {
            console.error("음성인식 오류:", event.error);
            // 'no-speech'는 조용할 때, 'aborted'는 우리가 끌 때 나는 정상 알림
            if (event.error !== 'no-speech' && event.error !== 'aborted') { 
                setTimeout(() => {
                    if (!isListening) {
                        try { recognition.start(); isListening = true; } catch (e) {}
                    }
                }, 1000);
            }
        };

        recognition.onend = function() {
            isListening = false;
            // 페이지가 이동하지 않는 한 (즉, /start에 머무는 한), 계속 켜져있도록 재시작
            if (window.location.pathname === "/start") {
                setTimeout(() => {
                    if (!isListening) { // ◀◀ 중복 실행 방지
                        try { 
                            recognition.start(); 
                            isListening = true;
                        } catch (e) {
                            console.log("음성 인식 재시작 실패 (onend):", e);
                        }
                    }
                }, 500); // 0.5초 뒤 재시작
            }
        };

        // 3. 페이지 로드 2초 뒤 STT 시작 (마이크 권한 팝업이 뜰 수 있음)
        setTimeout(() => {
            try {
                if (!isListening) { // ◀◀ 중복 실행 방지
                    recognition.start();
                    isListening = true;
                    console.log("음성 인식을 시작합니다. 마이크 권한을 허용해주세요.");
                }
            } catch (err) {
                console.error("음성 인식 시작 실패 (setTimeout):", err);
            }
        }, 2000); // 2초 뒤

    } else {
        console.warn("이 브라우저는 Web Speech API를 지원하지 않습니다.");
    }

    // 4. [수정됨] 클릭 리스너
    // "B스크립트"가 "A스크립트"를 방해하지 않도록,
    // 클릭하면 STT를 멈추고 페이지를 이동시킴
    document.body.addEventListener("click", () => {
        if (recognition && isListening) {
            recognition.abort(); // STT 강제 종료
            isListening = false;
        }
        window.location.href = "/capture";
    });
});
</script>

</body>
</html>